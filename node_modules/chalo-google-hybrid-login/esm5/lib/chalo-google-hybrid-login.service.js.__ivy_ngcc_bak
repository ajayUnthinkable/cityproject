/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { GOOGLE_LOGIN_CONFIG } from './models/chalo-google-login.config';
import { HttpClient, HttpHeaders, HttpParams } from '@angular/common/http';
import { ScriptLoadService } from './script-load.service';
import { Observable, Subject } from 'rxjs';
import { CookieService } from 'ngx-cookie-service';
import CryptoJS from 'crypto-js';
/**
 * @template T
 */
var GoogleLoginService = /** @class */ (function () {
    function GoogleLoginService(config, httpHandler, scriptService, cookieService) {
        var _this = this;
        this.config = config;
        this.httpHandler = httpHandler;
        this.scriptService = scriptService;
        this.cookieService = cookieService;
        this.subject = new Subject();
        this.loginResponsesubject = new Subject();
        this.scriptService.loadScript('https://apis.google.com/js/client:platform.js').subscribe(function (data) {
            try {
                gapi.load('client', function () {
                    _this.auth2 = gapi.auth2.init({
                        client_id: _this.config.auth.google.client_id,
                        scope: 'profile'
                    });
                });
            }
            catch (err) {
                console.log('error in initializing auth');
            }
        }, function (err) {
            console.log('erro', err);
        });
    }
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getGoogleLogin = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return this.authObservable = new Observable(function (observer) {
            if (!_this.auth2) {
                observer.error('Auth instance is not defined');
            }
            else {
                _this.auth2.grantOfflineAccess().then(function (res) {
                    _this.sendAuthorization(res.code).subscribe(function (data) {
                        _this.getUserToken(data).subscribe(function (d) {
                            _this.setCookieData(data);
                            observer.next(d);
                            observer.complete();
                        }, function (err) {
                            observer.error(err);
                        });
                    }, function (err) {
                        observer.error(err);
                    });
                });
            }
        });
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getUserDetails = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var user = this.getUserCookieValue();
        /** @type {?} */
        var url = this.config.user.authenticateUserUrl;
        url = url + "?userId=" + encodeURIComponent(user);
        return this.httpHandler.get(url);
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getToken = /**
     * @return {?}
     */
    function () {
        var _this = this;
        return this.userObservable = new Observable(function (observer) {
            _this.getUserDetails().subscribe(function (userDetails) {
                _this.getUserToken(userDetails).subscribe(function (d) {
                    observer.next(d);
                    observer.complete();
                }, function (err) {
                    observer.error(err);
                });
            }, function (err) {
                observer.error(err);
            });
        });
    };
    /**
     * @param {?} googleResponse
     * @return {?}
     */
    GoogleLoginService.prototype.setGoogleLoginResponse = /**
     * @param {?} googleResponse
     * @return {?}
     */
    function (googleResponse) {
        this.loginResponsesubject.next(googleResponse);
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getGoogleLoginResponse = /**
     * @return {?}
     */
    function () {
        return this.loginResponsesubject.asObservable();
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.isUserAuthenticated = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var userCookie = this.getUserCookieValue();
        if (userCookie) {
            return true;
        }
        else {
            return false;
        }
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getUserCookieValue = /**
     * @return {?}
     */
    function () {
        return this.cookieService.get(this.config.user.userCookie);
    };
    /**
     * @param {?} token
     * @return {?}
     */
    GoogleLoginService.prototype.sendAuthorization = /**
     * @param {?} token
     * @return {?}
     */
    function (token) {
        /** @type {?} */
        var url = this.config.authCodeUrl;
        /** @type {?} */
        var headerToken = {
            key: 'auth-code',
            value: token
        };
        /** @type {?} */
        var headers = new HttpHeaders({ 'auth-code': headerToken.value });
        /** @type {?} */
        var options = { headers: headers };
        return this.httpHandler.post(url, null, options);
    };
    /**
     * @param {?} userCredential
     * @return {?}
     */
    GoogleLoginService.prototype.getUserToken = /**
     * @param {?} userCredential
     * @return {?}
     */
    function (userCredential) {
        /** @type {?} */
        var data = {
            username: userCredential.username,
            password: userCredential.password,
            grant_type: 'password'
        };
        return this.getTokenFromServer(data);
    };
    /**
     * @param {?} refreshToken
     * @return {?}
     */
    GoogleLoginService.prototype.getUserTokenFromRefreshToken = /**
     * @param {?} refreshToken
     * @return {?}
     */
    function (refreshToken) {
        /** @type {?} */
        var data = {
            refresh_token: refreshToken,
            grant_type: 'refresh_token'
        };
        return this.getTokenFromServer(data);
    };
    /**
     * @param {?} data
     * @return {?}
     */
    GoogleLoginService.prototype.getTokenFromServer = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var url = this.config.userTokenServerUrl;
        /** @type {?} */
        var urlEncodedData = this.getEncodedData(data);
        /** @type {?} */
        var headerToken = {
            key: 'Authorization',
            value: 'Basic ' + btoa(this.config.auth.server.client_id + ":" + this.config.auth.server.client_secret)
        };
        /** @type {?} */
        var headers = new HttpHeaders({ Authorization: headerToken.value }).set('Content-Type', 'application/x-www-form-urlencoded');
        /** @type {?} */
        var options = { headers: headers };
        return this.httpHandler.post(url, urlEncodedData, options);
    };
    /**
     * @param {?} data
     * @return {?}
     */
    GoogleLoginService.prototype.getEncodedData = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        /** @type {?} */
        var urlEncodedDataPairs = [];
        for (var name_1 in data) {
            if (data.hasOwnProperty(name_1)) {
                urlEncodedDataPairs.push(encodeURIComponent(name_1) + '=' + encodeURIComponent(data[name_1]));
            }
        }
        /** @type {?} */
        var urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
        return urlEncodedData;
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.logoutUser = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var userCookie = this.getUserCookieValue();
        /** @type {?} */
        var url = "" + this.config.logout.logoutUrl;
        if (userCookie) {
            this.cookieService.delete(this.config.user.userCookie, '/', '.chalo.com');
            url = url + "?userId=" + userCookie;
        }
        return this.httpHandler.post(url, {}, { responseType: 'text' });
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.updateUserState = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var userCookie = this.getUserCookieValue();
        // this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedOut'), 7, '/', null, false, 'Lax')
        this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedOut'), 7, '/', '.chalo.com', false, 'Lax');
        if (userCookie) {
            // this.cookieService.delete(this.config.user.userCookie, '/');
            this.cookieService.delete(this.config.user.userCookie, '/', '.chalo.com');
        }
    };
    /**
     * @param {?} msg
     * @return {?}
     */
    GoogleLoginService.prototype.sendLogoutMessage = /**
     * @param {?} msg
     * @return {?}
     */
    function (msg) {
        this.subject.next({ message: msg });
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getLogoutMessage = /**
     * @return {?}
     */
    function () {
        return this.subject.asObservable();
    };
    /**
     * @param {?} stringToEncrypt
     * @return {?}
     */
    GoogleLoginService.prototype.encryptCookie = /**
     * @param {?} stringToEncrypt
     * @return {?}
     */
    function (stringToEncrypt) {
        /** @type {?} */
        var key = CryptoJS.enc.Utf8.parse('web_chalo_appkey');
        /** @type {?} */
        var encryptedString = CryptoJS.AES.encrypt(stringToEncrypt, key, {
            mode: CryptoJS.mode.ECB,
            padding: CryptoJS.pad.ZeroPadding
        });
        return encryptedString.toString();
    };
    /**
     * @param {?} encryptedString
     * @return {?}
     */
    GoogleLoginService.prototype.decryptString = /**
     * @param {?} encryptedString
     * @return {?}
     */
    function (encryptedString) {
        /** @type {?} */
        var key = CryptoJS.enc.Utf8.parse('web_chalo_appkey');
        /** @type {?} */
        var decrypted = CryptoJS.AES.decrypt(encryptedString, key, {
            mode: CryptoJS.mode.ECB,
            padding: CryptoJS.pad.ZeroPadding
        });
        return decrypted.toString(CryptoJS.enc.Utf8);
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getUserCookie = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var encryptedCookie = this.getUserCookieValue();
        /** @type {?} */
        var decryptedUserCookie;
        if (encryptedCookie)
            decryptedUserCookie = this.decryptString(encryptedCookie);
        return decryptedUserCookie;
    };
    /**
     * @param {?} number
     * @return {?}
     */
    GoogleLoginService.prototype.sendOtp = /**
     * @param {?} number
     * @return {?}
     */
    function (number) {
        /** @type {?} */
        var url = "" + this.config.sendOtpUrl;
        return this.httpHandler.post(url, { "number": number });
    };
    /**
     * @param {?} body
     * @return {?}
     */
    GoogleLoginService.prototype.validateUser = /**
     * @param {?} body
     * @return {?}
     */
    function (body) {
        /** @type {?} */
        var url = "" + this.config.validateUserUrl;
        return this.httpHandler.post(url, body);
    };
    /**
     * @param {?} otp
     * @param {?} number
     * @return {?}
     */
    GoogleLoginService.prototype.validateOtp = /**
     * @param {?} otp
     * @param {?} number
     * @return {?}
     */
    function (otp, number) {
        /** @type {?} */
        var url = "" + this.config.validateOtpUrl;
        /** @type {?} */
        var params = this.getURLSearchParams()
            .set("otp", otp)
            .set("mobile", number);
        return this.httpHandler.get(url, { params: params });
    };
    /**
     * @param {?} otp
     * @param {?} number
     * @return {?}
     */
    GoogleLoginService.prototype.getMobileToken = /**
     * @param {?} otp
     * @param {?} number
     * @return {?}
     */
    function (otp, number) {
        var _this = this;
        return this.userObservable = new Observable(function (observer) {
            _this.validateOtp(otp, number).subscribe(function (userDetails) {
                _this.getUserToken(userDetails).subscribe(function (d) {
                    _this.setCookieData(userDetails);
                    observer.next(d);
                    observer.complete();
                }, function (err) {
                    observer.error(err);
                });
            }, function (err) {
                observer.error(err);
            });
        });
    };
    /**
     * @return {?}
     */
    GoogleLoginService.prototype.getURLSearchParams = /**
     * @return {?}
     */
    function () {
        return new HttpParams();
    };
    /**
     * @param {?} data
     * @return {?}
     */
    GoogleLoginService.prototype.setCookieData = /**
     * @param {?} data
     * @return {?}
     */
    function (data) {
        if (data['userId']) {
            /** @type {?} */
            var encryptedString = this.encryptCookie(data['userId']);
            this.cookieService.set(this.config.user.userCookie, encryptedString, 7, '/', '.chalo.com', false, 'Lax');
            // this.cookieService.set(this.config.user.userCookie, encryptedString, 7, '/', null, false, 'Lax');
        }
        this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedIn'), 7, '/', '.chalo.com', false, 'Lax');
        // this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedIn'), 7, '/', null, false, 'Lax')
    };
    GoogleLoginService.decorators = [
        { type: Injectable }
    ];
    /** @nocollapse */
    GoogleLoginService.ctorParameters = function () { return [
        { type: undefined, decorators: [{ type: Inject, args: [GOOGLE_LOGIN_CONFIG,] }] },
        { type: HttpClient },
        { type: ScriptLoadService },
        { type: CookieService }
    ]; };
    return GoogleLoginService;
}());
export { GoogleLoginService };
if (false) {
    /** @type {?} */
    GoogleLoginService.prototype.auth2;
    /** @type {?} */
    GoogleLoginService.prototype.authObservable;
    /** @type {?} */
    GoogleLoginService.prototype.userObservable;
    /** @type {?} */
    GoogleLoginService.prototype.subject;
    /** @type {?} */
    GoogleLoginService.prototype.loginResponsesubject;
    /** @type {?} */
    GoogleLoginService.prototype.config;
    /** @type {?} */
    GoogleLoginService.prototype.httpHandler;
    /** @type {?} */
    GoogleLoginService.prototype.scriptService;
    /** @type {?} */
    GoogleLoginService.prototype.cookieService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbG8tZ29vZ2xlLWh5YnJpZC1sb2dpbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vY2hhbG8tZ29vZ2xlLWh5YnJpZC1sb2dpbi8iLCJzb3VyY2VzIjpbImxpYi9jaGFsby1nb29nbGUtaHlicmlkLWxvZ2luLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxtQkFBbUIsRUFBcUIsTUFBTSxvQ0FBb0MsQ0FBQztBQUM1RixPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMzRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFbkQsT0FBTyxRQUFRLE1BQU0sV0FBVyxDQUFDOzs7OztJQWEvQiw0QkFBaUQsTUFBeUIsRUFBVSxXQUF1QixFQUFVLGFBQWdDLEVBQzNJO1FBRFYsaUJBaUJDO1FBakJnRCxXQUFNLEdBQU4sTUFBTSxDQUFtQjtRQUFVLGdCQUFXLEdBQVgsV0FBVyxDQUFZO1FBQVUsa0JBQWEsR0FBYixhQUFhLENBQW1CO1FBQzNJLGtCQUFhLEdBQWIsYUFBYTt1QkFMTCxJQUFJLE9BQU8sRUFBTztvQ0FFYixJQUFJLE9BQU8sRUFBdUI7UUFJdkQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsK0NBQStDLENBQUMsQ0FBQyxTQUFTLENBQUMsVUFBQyxJQUFJO1lBQzVGLElBQUksQ0FBQztnQkFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtvQkFDbEIsS0FBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElB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QWIsVUFBYyxJQUFJO1FBQ2hCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7O1lBQ25CLElBQUksZUFBZSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFDLGVBQWUsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBQyxLQUFLLEVBQUMsS0FBSyxDQUFDLENBQUM7O1NBRXZHO1FBRUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFDLFlBQVksRUFBQyxLQUFLLEVBQUMsS0FBSyxDQUFDLENBQUE7O0tBRTFIOztnQkEzUEYsVUFBVTs7OztnREFTSSxNQUFNLFNBQUMsbUJBQW1CO2dCQWxCaEMsVUFBVTtnQkFDVixpQkFBaUI7Z0JBRWpCLGFBQWE7OzZCQUx0Qjs7U0FZYSxrQkFBa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEdPT0dMRV9MT0dJTl9DT05GSUcsIEdvb2dsZUxvZ2luQ29uZmlnIH0gZnJvbSAnLi9tb2RlbHMvY2hhbG8tZ29vZ2xlLWxvZ2luLmNvbmZpZyc7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycywgSHR0cFBhcmFtcyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IFNjcmlwdExvYWRTZXJ2aWNlIH0gZnJvbSAnLi9zY3JpcHQtbG9hZC5zZXJ2aWNlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IENvb2tpZVNlcnZpY2UgfSBmcm9tICduZ3gtY29va2llLXNlcnZpY2UnO1xuaW1wb3J0IHsgR29vZ2xlTG9naW5SZXNwb25zZSB9IGZyb20gJy4vbW9kZWxzJztcbmltcG9ydCBDcnlwdG9KUyBmcm9tICdjcnlwdG8tanMnO1xuXG5kZWNsYXJlIHZhciBnYXBpO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgR29vZ2xlTG9naW5TZXJ2aWNlPFQ+IHtcbiAgYXV0aDI7XG4gIGF1dGhPYnNlcnZhYmxlOiBPYnNlcnZhYmxlPGJvb2xlYW4gfCBUPjtcbiAgdXNlck9ic2VydmFibGU6IE9ic2VydmFibGU8Ym9vbGVhbiB8IFQ+O1xuICBwcml2YXRlIHN1YmplY3QgPSBuZXcgU3ViamVjdDxhbnk+KCk7XG5cbiAgbG9naW5SZXNwb25zZXN1YmplY3QgPSBuZXcgU3ViamVjdDxHb29nbGVMb2dpblJlc3BvbnNlPigpO1xuXG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoR09PR0xFX0xPR0lOX0NPTkZJRykgcHJpdmF0ZSBjb25maWc6IEdvb2dsZUxvZ2luQ29uZmlnLCBwcml2YXRlIGh0dHBIYW5kbGVyOiBIdHRwQ2xpZW50LCBwcml2YXRlIHNjcmlwdFNlcnZpY2U6IFNjcmlwdExvYWRTZXJ2aWNlLFxuICAgIHByaXZhdGUgY29va2llU2VydmljZTogQ29va2llU2VydmljZSkge1xuICAgIHRoaXMuc2NyaXB0U2VydmljZS5sb2FkU2NyaXB0KCdodHRwczovL2FwaXMuZ29vZ2xlLmNvbS9qcy9jbGllbnQ6cGxhdGZvcm0uanMnKS5zdWJzY3JpYmUoKGRhdGEpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGdhcGkubG9hZCgnY2xpZW50JywgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuYXV0aDIgPSBnYXBpLmF1dGgyLmluaXQoe1xuICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmNvbmZpZy5hdXRoLmdvb2dsZS5jbGllbnRfaWQsXG4gICAgICAgICAgICBzY29wZTogJ3Byb2ZpbGUnXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdlcnJvciBpbiBpbml0aWFsaXppbmcgYXV0aCcpO1xuICAgICAgfVxuICAgIH0sIGVyciA9PiB7XG4gICAgICBjb25zb2xlLmxvZygnZXJybycsIGVycik7XG4gICAgfSk7XG5cbiAgfVxuXG4gIGdldEdvb2dsZUxvZ2luKCkge1xuICAgIHJldHVybiB0aGlzLmF1dGhPYnNlcnZhYmxlID0gbmV3IE9ic2VydmFibGU8Ym9vbGVhbiB8IFQ+KChvYnNlcnZlcikgPT4ge1xuICAgICAgaWYgKCF0aGlzLmF1dGgyKSB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKCdBdXRoIGluc3RhbmNlIGlzIG5vdCBkZWZpbmVkJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmF1dGgyLmdyYW50T2ZmbGluZUFjY2VzcygpLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAgIHRoaXMuc2VuZEF1dGhvcml6YXRpb24ocmVzLmNvZGUpLnN1YnNjcmliZSgoZGF0YSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5nZXRVc2VyVG9rZW4oZGF0YSkuc3Vic2NyaWJlKChkOiBUKSA9PiB7XG4gICAgICAgICAgICAgdGhpcy5zZXRDb29raWVEYXRhKGRhdGEpXG4gICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZCk7XG4gICAgICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgIH0pO1xuXG4gIH1cblxuICBnZXRVc2VyRGV0YWlscygpIHtcbiAgICBsZXQgdXNlciA9IHRoaXMuZ2V0VXNlckNvb2tpZVZhbHVlKCk7XG4gICAgdmFyIHVybCA9IHRoaXMuY29uZmlnLnVzZXIuYXV0aGVudGljYXRlVXNlclVybDtcbiAgICB1cmw9YCR7dXJsfT91c2VySWQ9JHtlbmNvZGVVUklDb21wb25lbnQodXNlcil9YFxuICAgIHJldHVybiB0aGlzLmh0dHBIYW5kbGVyLmdldCh1cmwpO1xuICB9XG5cbiAgZ2V0VG9rZW4oKSB7XG4gICAgcmV0dXJuIHRoaXMudXNlck9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZTxib29sZWFuIHwgVD4oKG9ic2VydmVyKSA9PiB7XG4gICAgICB0aGlzLmdldFVzZXJEZXRhaWxzKCkuc3Vic2NyaWJlKCh1c2VyRGV0YWlscykgPT4ge1xuICAgICAgICB0aGlzLmdldFVzZXJUb2tlbih1c2VyRGV0YWlscykuc3Vic2NyaWJlKChkOiBUKSA9PiB7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChkKTtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgfSlcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIHNldEdvb2dsZUxvZ2luUmVzcG9uc2UoZ29vZ2xlUmVzcG9uc2UpIHtcbiAgICB0aGlzLmxvZ2luUmVzcG9uc2VzdWJqZWN0Lm5leHQoZ29vZ2xlUmVzcG9uc2UpO1xuXG4gIH1cblxuICBnZXRHb29nbGVMb2dpblJlc3BvbnNlKCk6IE9ic2VydmFibGU8R29vZ2xlTG9naW5SZXNwb25zZT4ge1xuICAgIHJldHVybiB0aGlzLmxvZ2luUmVzcG9uc2VzdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cblxuICBpc1VzZXJBdXRoZW50aWNhdGVkKCkge1xuICAgIGxldCB1c2VyQ29va2llID0gdGhpcy5nZXRVc2VyQ29va2llVmFsdWUoKTtcbiAgICBpZiAodXNlckNvb2tpZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBnZXRVc2VyQ29va2llVmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29va2llU2VydmljZS5nZXQodGhpcy5jb25maWcudXNlci51c2VyQ29va2llKTtcbiAgfVxuXG4gIHNlbmRBdXRob3JpemF0aW9uKHRva2VuKSB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5jb25maWcuYXV0aENvZGVVcmw7XG4gICAgY29uc3QgaGVhZGVyVG9rZW4gPSB7XG4gICAgICBrZXk6ICdhdXRoLWNvZGUnLFxuICAgICAgdmFsdWU6IHRva2VuXG4gICAgfTtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgJ2F1dGgtY29kZSc6IGhlYWRlclRva2VuLnZhbHVlIH0pO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7IGhlYWRlcnMgfTtcbiAgICByZXR1cm4gdGhpcy5odHRwSGFuZGxlci5wb3N0KHVybCwgbnVsbCwgb3B0aW9ucyk7XG4gIH1cblxuICBnZXRVc2VyVG9rZW4odXNlckNyZWRlbnRpYWwpIHtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgdXNlcm5hbWU6IHVzZXJDcmVkZW50aWFsLnVzZXJuYW1lLFxuICAgICAgcGFzc3dvcmQ6IHVzZXJDcmVkZW50aWFsLnBhc3N3b3JkLFxuICAgICAgZ3JhbnRfdHlwZTogJ3Bhc3N3b3JkJ1xuICAgIH07XG4gICAgcmV0dXJuIHRoaXMuZ2V0VG9rZW5Gcm9tU2VydmVyKGRhdGEpO1xuICB9XG5cbiAgZ2V0VXNlclRva2VuRnJvbVJlZnJlc2hUb2tlbihyZWZyZXNoVG9rZW4pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IGRhdGEgPSB7XG4gICAgICByZWZyZXNoX3Rva2VuOiByZWZyZXNoVG9rZW4sXG4gICAgICBncmFudF90eXBlOiAncmVmcmVzaF90b2tlbidcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmdldFRva2VuRnJvbVNlcnZlcihkYXRhKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VG9rZW5Gcm9tU2VydmVyKGRhdGEpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMuY29uZmlnLnVzZXJUb2tlblNlcnZlclVybDtcbiAgICBjb25zdCB1cmxFbmNvZGVkRGF0YSA9IHRoaXMuZ2V0RW5jb2RlZERhdGEoZGF0YSk7XG4gICAgY29uc3QgaGVhZGVyVG9rZW4gPSB7XG4gICAgICBrZXk6ICdBdXRob3JpemF0aW9uJyxcbiAgICAgIHZhbHVlOiAnQmFzaWMgJyArIGJ0b2EoYCR7dGhpcy5jb25maWcuYXV0aC5zZXJ2ZXIuY2xpZW50X2lkfToke3RoaXMuY29uZmlnLmF1dGguc2VydmVyLmNsaWVudF9zZWNyZXR9YClcbiAgICB9O1xuICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSHR0cEhlYWRlcnMoeyBBdXRob3JpemF0aW9uOiBoZWFkZXJUb2tlbi52YWx1ZSB9KS5zZXQoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSB7IGhlYWRlcnMgfTtcblxuICAgIHJldHVybiB0aGlzLmh0dHBIYW5kbGVyLnBvc3QodXJsLCB1cmxFbmNvZGVkRGF0YSwgb3B0aW9ucyk7XG4gIH1cblxuICBwcml2YXRlIGdldEVuY29kZWREYXRhKGRhdGEpIHtcbiAgICBjb25zdCB1cmxFbmNvZGVkRGF0YVBhaXJzID0gW107XG4gICAgZm9yIChjb25zdCBuYW1lIGluIGRhdGEpIHtcbiAgICAgIGlmIChkYXRhLmhhc093blByb3BlcnR5KG5hbWUpKSB7XG4gICAgICAgIHVybEVuY29kZWREYXRhUGFpcnMucHVzaChlbmNvZGVVUklDb21wb25lbnQobmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZGF0YVtuYW1lXSkpO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCB1cmxFbmNvZGVkRGF0YSA9IHVybEVuY29kZWREYXRhUGFpcnMuam9pbignJicpLnJlcGxhY2UoLyUyMC9nLCAnKycpO1xuICAgIHJldHVybiB1cmxFbmNvZGVkRGF0YTtcbiAgfVxuXG4gIGxvZ291dFVzZXIoKSB7XG4gICAgbGV0IHVzZXJDb29raWUgPSB0aGlzLmdldFVzZXJDb29raWVWYWx1ZSgpXG4gICAgbGV0IHVybCA9IGAke3RoaXMuY29uZmlnLmxvZ291dC5sb2dvdXRVcmx9YDtcbiAgICBpZiAodXNlckNvb2tpZSkge1xuICAgICAgdGhpcy5jb29raWVTZXJ2aWNlLmRlbGV0ZSh0aGlzLmNvbmZpZy51c2VyLnVzZXJDb29raWUsICcvJywgJy5jaGFsby5jb20nKTtcbiAgICAgIHVybCA9IGAke3VybH0/dXNlcklkPSR7dXNlckNvb2tpZX1gXG4gICAgfVxuICAgIHJldHVybiB0aGlzLmh0dHBIYW5kbGVyLnBvc3QodXJsLCB7fSwgeyByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KVxuICB9XG5cbiAgdXBkYXRlVXNlclN0YXRlKCkge1xuICAgIGxldCB1c2VyQ29va2llID0gdGhpcy5nZXRVc2VyQ29va2llVmFsdWUoKVxuICAgIC8vIHRoaXMuY29va2llU2VydmljZS5zZXQodGhpcy5jb25maWcudXNlci5sb2dpblN0YXRlQ29va2llLCB0aGlzLmVuY3J5cHRDb29raWUoJ2xvZ2dlZE91dCcpLCA3LCAnLycsIG51bGwsIGZhbHNlLCAnTGF4JylcblxuICAgIHRoaXMuY29va2llU2VydmljZS5zZXQodGhpcy5jb25maWcudXNlci5sb2dpblN0YXRlQ29va2llLCB0aGlzLmVuY3J5cHRDb29raWUoJ2xvZ2dlZE91dCcpLCA3LCAnLycsICcuY2hhbG8uY29tJywgZmFsc2UsICdMYXgnKVxuICAgIGlmICh1c2VyQ29va2llKSB7XG4gICAgICAvLyB0aGlzLmNvb2tpZVNlcnZpY2UuZGVsZXRlKHRoaXMuY29uZmlnLnVzZXIudXNlckNvb2tpZSwgJy8nKTtcbiAgICAgIHRoaXMuY29va2llU2VydmljZS5kZWxldGUodGhpcy5jb25maWcudXNlci51c2VyQ29va2llLCAnLycsICcuY2hhbG8uY29tJyk7XG4gICAgfVxuICB9XG5cbiAgc2VuZExvZ291dE1lc3NhZ2UobXNnOiBzdHJpbmcpIHtcbiAgICB0aGlzLnN1YmplY3QubmV4dCh7IG1lc3NhZ2U6IG1zZyB9KTtcbiAgfVxuXG4gIGdldExvZ291dE1lc3NhZ2UoKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5zdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICB9XG5cbiAgZW5jcnlwdENvb2tpZShzdHJpbmdUb0VuY3J5cHQpIHtcbiAgICB2YXIga2V5ID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoJ3dlYl9jaGFsb19hcHBrZXknKTtcbiAgICB2YXIgZW5jcnlwdGVkU3RyaW5nID0gQ3J5cHRvSlMuQUVTLmVuY3J5cHQoc3RyaW5nVG9FbmNyeXB0LCBrZXksIHtcbiAgICAgIG1vZGU6IENyeXB0b0pTLm1vZGUuRUNCLFxuICAgICAgcGFkZGluZzogQ3J5cHRvSlMucGFkLlplcm9QYWRkaW5nXG4gICAgfSk7XG4gICAgcmV0dXJuIGVuY3J5cHRlZFN0cmluZy50b1N0cmluZygpXG4gIH1cblxuICBkZWNyeXB0U3RyaW5nKGVuY3J5cHRlZFN0cmluZykge1xuICAgIHZhciBrZXkgPSBDcnlwdG9KUy5lbmMuVXRmOC5wYXJzZSgnd2ViX2NoYWxvX2FwcGtleScpO1xuICAgIHZhciBkZWNyeXB0ZWQgPSBDcnlwdG9KUy5BRVMuZGVjcnlwdChlbmNyeXB0ZWRTdHJpbmcsIGtleSwge1xuICAgICAgbW9kZTogQ3J5cHRvSlMubW9kZS5FQ0IsXG4gICAgICBwYWRkaW5nOiBDcnlwdG9KUy5wYWQuWmVyb1BhZGRpbmdcbiAgICB9KTtcbiAgICByZXR1cm4gZGVjcnlwdGVkLnRvU3RyaW5nKENyeXB0b0pTLmVuYy5VdGY4KTtcbiAgfVxuXG4gIGdldFVzZXJDb29raWUoKXtcbiAgICBsZXQgZW5jcnlwdGVkQ29va2llPXRoaXMuZ2V0VXNlckNvb2tpZVZhbHVlKCk7XG4gICAgbGV0IGRlY3J5cHRlZFVzZXJDb29raWU7XG4gICAgaWYoZW5jcnlwdGVkQ29va2llKSBkZWNyeXB0ZWRVc2VyQ29va2llPSB0aGlzLmRlY3J5cHRTdHJpbmcoZW5jcnlwdGVkQ29va2llKTtcbiAgICByZXR1cm4gZGVjcnlwdGVkVXNlckNvb2tpZTtcbiAgfVxuXG4gIHNlbmRPdHAobnVtYmVyKXtcbiAgICBsZXQgdXJsPWAke3RoaXMuY29uZmlnLnNlbmRPdHBVcmx9YFxuICAgcmV0dXJuIHRoaXMuaHR0cEhhbmRsZXIucG9zdCh1cmwse1wibnVtYmVyXCI6bnVtYmVyfSlcbiAgfVxuXG4gIHZhbGlkYXRlVXNlcihib2R5KXtcbiAgICBsZXQgdXJsPWAke3RoaXMuY29uZmlnLnZhbGlkYXRlVXNlclVybH1gXG4gICAgcmV0dXJuIHRoaXMuaHR0cEhhbmRsZXIucG9zdCh1cmwsIGJvZHkpXG4gIH1cblxuICB2YWxpZGF0ZU90cChvdHAsbnVtYmVyKXtcbiAgICBsZXQgdXJsPWAke3RoaXMuY29uZmlnLnZhbGlkYXRlT3RwVXJsfWBcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5nZXRVUkxTZWFyY2hQYXJhbXMoKVxuICAgIC5zZXQoXCJvdHBcIiwgb3RwKVxuICAgIC5zZXQoXCJtb2JpbGVcIiwgbnVtYmVyKTtcbiAgICByZXR1cm4gdGhpcy5odHRwSGFuZGxlci5nZXQodXJsLCB7cGFyYW1zfSk7XG4gIH1cblxuICBnZXRNb2JpbGVUb2tlbihvdHAsbnVtYmVyKXtcbiAgICByZXR1cm4gdGhpcy51c2VyT2JzZXJ2YWJsZSA9IG5ldyBPYnNlcnZhYmxlPGJvb2xlYW4gfCBUPigob2JzZXJ2ZXIpID0+IHtcbiAgICAgIHRoaXMudmFsaWRhdGVPdHAob3RwLG51bWJlcikuc3Vic2NyaWJlKCh1c2VyRGV0YWlscykgPT4ge1xuICAgICAgICB0aGlzLmdldFVzZXJUb2tlbih1c2VyRGV0YWlscykuc3Vic2NyaWJlKChkOiBUKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXRDb29raWVEYXRhKHVzZXJEZXRhaWxzKTtcbiAgICAgICAgICBvYnNlcnZlci5uZXh0KGQpO1xuICAgICAgICAgIG9ic2VydmVyLmNvbXBsZXRlKCk7XG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICB9KVxuICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgfSlcbiAgICB9KVxuICB9XG5cbiAgZ2V0VVJMU2VhcmNoUGFyYW1zKCk6IEh0dHBQYXJhbXMge1xuICAgIHJldHVybiBuZXcgSHR0cFBhcmFtcygpO1xuICB9XG5cbiAgc2V0Q29va2llRGF0YShkYXRhKXtcbiAgICBpZiAoZGF0YVsndXNlcklkJ10pIHtcbiAgICAgIHZhciBlbmNyeXB0ZWRTdHJpbmcgPSB0aGlzLmVuY3J5cHRDb29raWUoZGF0YVsndXNlcklkJ10pO1xuICAgICAgdGhpcy5jb29raWVTZXJ2aWNlLnNldCh0aGlzLmNvbmZpZy51c2VyLnVzZXJDb29raWUsZW5jcnlwdGVkU3RyaW5nLCA3LCAnLycsICcuY2hhbG8uY29tJyxmYWxzZSwnTGF4Jyk7XG4gICAgICAvLyB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KHRoaXMuY29uZmlnLnVzZXIudXNlckNvb2tpZSwgZW5jcnlwdGVkU3RyaW5nLCA3LCAnLycsIG51bGwsIGZhbHNlLCAnTGF4Jyk7XG4gICAgfVxuXG4gICAgdGhpcy5jb29raWVTZXJ2aWNlLnNldCh0aGlzLmNvbmZpZy51c2VyLmxvZ2luU3RhdGVDb29raWUsdGhpcy5lbmNyeXB0Q29va2llKCdsb2dnZWRJbicpLCA3LCAnLycsJy5jaGFsby5jb20nLGZhbHNlLCdMYXgnKVxuICAgIC8vIHRoaXMuY29va2llU2VydmljZS5zZXQodGhpcy5jb25maWcudXNlci5sb2dpblN0YXRlQ29va2llLCB0aGlzLmVuY3J5cHRDb29raWUoJ2xvZ2dlZEluJyksIDcsICcvJywgbnVsbCwgZmFsc2UsICdMYXgnKVxuICB9XG5cbn1cblxuIl19