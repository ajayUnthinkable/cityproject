/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,uselessCode} checked by tsc
 */
import { Inject, Injectable } from '@angular/core';
import { GOOGLE_LOGIN_CONFIG } from './models/chalo-google-login.config';
import { HttpClient, HttpHeaders, HttpParams } from '@angular/common/http';
import { ScriptLoadService } from './script-load.service';
import { Observable, Subject } from 'rxjs';
import { CookieService } from 'ngx-cookie-service';
import CryptoJS from 'crypto-js';
/**
 * @template T
 */
export class GoogleLoginService {
    /**
     * @param {?} config
     * @param {?} httpHandler
     * @param {?} scriptService
     * @param {?} cookieService
     */
    constructor(config, httpHandler, scriptService, cookieService) {
        this.config = config;
        this.httpHandler = httpHandler;
        this.scriptService = scriptService;
        this.cookieService = cookieService;
        this.subject = new Subject();
        this.loginResponsesubject = new Subject();
        this.scriptService.loadScript('https://apis.google.com/js/client:platform.js').subscribe((data) => {
            try {
                gapi.load('client', () => {
                    this.auth2 = gapi.auth2.init({
                        client_id: this.config.auth.google.client_id,
                        scope: 'profile'
                    });
                });
            }
            catch (err) {
                console.log('error in initializing auth');
            }
        }, err => {
            console.log('erro', err);
        });
    }
    /**
     * @return {?}
     */
    getGoogleLogin() {
        return this.authObservable = new Observable((observer) => {
            if (!this.auth2) {
                observer.error('Auth instance is not defined');
            }
            else {
                this.auth2.grantOfflineAccess().then((res) => {
                    this.sendAuthorization(res.code).subscribe((data) => {
                        this.getUserToken(data).subscribe((d) => {
                            this.setCookieData(data);
                            observer.next(d);
                            observer.complete();
                        }, (err) => {
                            observer.error(err);
                        });
                    }, (err) => {
                        observer.error(err);
                    });
                });
            }
        });
    }
    /**
     * @return {?}
     */
    getUserDetails() {
        /** @type {?} */
        let user = this.getUserCookieValue();
        /** @type {?} */
        var url = this.config.user.authenticateUserUrl;
        url = `${url}?userId=${encodeURIComponent(user)}`;
        return this.httpHandler.get(url);
    }
    /**
     * @return {?}
     */
    getToken() {
        return this.userObservable = new Observable((observer) => {
            this.getUserDetails().subscribe((userDetails) => {
                this.getUserToken(userDetails).subscribe((d) => {
                    observer.next(d);
                    observer.complete();
                }, (err) => {
                    observer.error(err);
                });
            }, (err) => {
                observer.error(err);
            });
        });
    }
    /**
     * @param {?} googleResponse
     * @return {?}
     */
    setGoogleLoginResponse(googleResponse) {
        this.loginResponsesubject.next(googleResponse);
    }
    /**
     * @return {?}
     */
    getGoogleLoginResponse() {
        return this.loginResponsesubject.asObservable();
    }
    /**
     * @return {?}
     */
    isUserAuthenticated() {
        /** @type {?} */
        let userCookie = this.getUserCookieValue();
        if (userCookie) {
            return true;
        }
        else {
            return false;
        }
    }
    /**
     * @return {?}
     */
    getUserCookieValue() {
        return this.cookieService.get(this.config.user.userCookie);
    }
    /**
     * @param {?} token
     * @return {?}
     */
    sendAuthorization(token) {
        /** @type {?} */
        const url = this.config.authCodeUrl;
        /** @type {?} */
        const headerToken = {
            key: 'auth-code',
            value: token
        };
        /** @type {?} */
        const headers = new HttpHeaders({ 'auth-code': headerToken.value });
        /** @type {?} */
        const options = { headers };
        return this.httpHandler.post(url, null, options);
    }
    /**
     * @param {?} userCredential
     * @return {?}
     */
    getUserToken(userCredential) {
        /** @type {?} */
        const data = {
            username: userCredential.username,
            password: userCredential.password,
            grant_type: 'password'
        };
        return this.getTokenFromServer(data);
    }
    /**
     * @param {?} refreshToken
     * @return {?}
     */
    getUserTokenFromRefreshToken(refreshToken) {
        /** @type {?} */
        const data = {
            refresh_token: refreshToken,
            grant_type: 'refresh_token'
        };
        return this.getTokenFromServer(data);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    getTokenFromServer(data) {
        /** @type {?} */
        const url = this.config.userTokenServerUrl;
        /** @type {?} */
        const urlEncodedData = this.getEncodedData(data);
        /** @type {?} */
        const headerToken = {
            key: 'Authorization',
            value: 'Basic ' + btoa(`${this.config.auth.server.client_id}:${this.config.auth.server.client_secret}`)
        };
        /** @type {?} */
        const headers = new HttpHeaders({ Authorization: headerToken.value }).set('Content-Type', 'application/x-www-form-urlencoded');
        /** @type {?} */
        const options = { headers };
        return this.httpHandler.post(url, urlEncodedData, options);
    }
    /**
     * @param {?} data
     * @return {?}
     */
    getEncodedData(data) {
        /** @type {?} */
        const urlEncodedDataPairs = [];
        for (const name in data) {
            if (data.hasOwnProperty(name)) {
                urlEncodedDataPairs.push(encodeURIComponent(name) + '=' + encodeURIComponent(data[name]));
            }
        }
        /** @type {?} */
        const urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
        return urlEncodedData;
    }
    /**
     * @return {?}
     */
    logoutUser() {
        /** @type {?} */
        let userCookie = this.getUserCookieValue();
        /** @type {?} */
        let url = `${this.config.logout.logoutUrl}`;
        if (userCookie) {
            this.cookieService.delete(this.config.user.userCookie, '/', '.chalo.com');
            url = `${url}?userId=${userCookie}`;
        }
        return this.httpHandler.post(url, {}, { responseType: 'text' });
    }
    /**
     * @return {?}
     */
    updateUserState() {
        /** @type {?} */
        let userCookie = this.getUserCookieValue();
        // this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedOut'), 7, '/', null, false, 'Lax')
        this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedOut'), 7, '/', '.chalo.com', false, 'Lax');
        if (userCookie) {
            // this.cookieService.delete(this.config.user.userCookie, '/');
            this.cookieService.delete(this.config.user.userCookie, '/', '.chalo.com');
        }
    }
    /**
     * @param {?} msg
     * @return {?}
     */
    sendLogoutMessage(msg) {
        this.subject.next({ message: msg });
    }
    /**
     * @return {?}
     */
    getLogoutMessage() {
        return this.subject.asObservable();
    }
    /**
     * @param {?} stringToEncrypt
     * @return {?}
     */
    encryptCookie(stringToEncrypt) {
        /** @type {?} */
        var key = CryptoJS.enc.Utf8.parse('web_chalo_appkey');
        /** @type {?} */
        var encryptedString = CryptoJS.AES.encrypt(stringToEncrypt, key, {
            mode: CryptoJS.mode.ECB,
            padding: CryptoJS.pad.ZeroPadding
        });
        return encryptedString.toString();
    }
    /**
     * @param {?} encryptedString
     * @return {?}
     */
    decryptString(encryptedString) {
        /** @type {?} */
        var key = CryptoJS.enc.Utf8.parse('web_chalo_appkey');
        /** @type {?} */
        var decrypted = CryptoJS.AES.decrypt(encryptedString, key, {
            mode: CryptoJS.mode.ECB,
            padding: CryptoJS.pad.ZeroPadding
        });
        return decrypted.toString(CryptoJS.enc.Utf8);
    }
    /**
     * @return {?}
     */
    getUserCookie() {
        /** @type {?} */
        let encryptedCookie = this.getUserCookieValue();
        /** @type {?} */
        let decryptedUserCookie;
        if (encryptedCookie)
            decryptedUserCookie = this.decryptString(encryptedCookie);
        return decryptedUserCookie;
    }
    /**
     * @param {?} number
     * @return {?}
     */
    sendOtp(number) {
        /** @type {?} */
        let url = `${this.config.sendOtpUrl}`;
        return this.httpHandler.post(url, { "number": number });
    }
    /**
     * @param {?} body
     * @return {?}
     */
    validateUser(body) {
        /** @type {?} */
        let url = `${this.config.validateUserUrl}`;
        return this.httpHandler.post(url, body);
    }
    /**
     * @param {?} otp
     * @param {?} number
     * @return {?}
     */
    validateOtp(otp, number) {
        /** @type {?} */
        let url = `${this.config.validateOtpUrl}`;
        /** @type {?} */
        let params = this.getURLSearchParams()
            .set("otp", otp)
            .set("mobile", number);
        return this.httpHandler.get(url, { params });
    }
    /**
     * @param {?} otp
     * @param {?} number
     * @return {?}
     */
    getMobileToken(otp, number) {
        return this.userObservable = new Observable((observer) => {
            this.validateOtp(otp, number).subscribe((userDetails) => {
                this.getUserToken(userDetails).subscribe((d) => {
                    this.setCookieData(userDetails);
                    observer.next(d);
                    observer.complete();
                }, (err) => {
                    observer.error(err);
                });
            }, (err) => {
                observer.error(err);
            });
        });
    }
    /**
     * @return {?}
     */
    getURLSearchParams() {
        return new HttpParams();
    }
    /**
     * @param {?} data
     * @return {?}
     */
    setCookieData(data) {
        if (data['userId']) {
            /** @type {?} */
            var encryptedString = this.encryptCookie(data['userId']);
            this.cookieService.set(this.config.user.userCookie, encryptedString, 7, '/', '.chalo.com', false, 'Lax');
            // this.cookieService.set(this.config.user.userCookie, encryptedString, 7, '/', null, false, 'Lax');
        }
        this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedIn'), 7, '/', '.chalo.com', false, 'Lax');
        // this.cookieService.set(this.config.user.loginStateCookie, this.encryptCookie('loggedIn'), 7, '/', null, false, 'Lax')
    }
}
GoogleLoginService.decorators = [
    { type: Injectable }
];
/** @nocollapse */
GoogleLoginService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [GOOGLE_LOGIN_CONFIG,] }] },
    { type: HttpClient },
    { type: ScriptLoadService },
    { type: CookieService }
];
if (false) {
    /** @type {?} */
    GoogleLoginService.prototype.auth2;
    /** @type {?} */
    GoogleLoginService.prototype.authObservable;
    /** @type {?} */
    GoogleLoginService.prototype.userObservable;
    /** @type {?} */
    GoogleLoginService.prototype.subject;
    /** @type {?} */
    GoogleLoginService.prototype.loginResponsesubject;
    /** @type {?} */
    GoogleLoginService.prototype.config;
    /** @type {?} */
    GoogleLoginService.prototype.httpHandler;
    /** @type {?} */
    GoogleLoginService.prototype.scriptService;
    /** @type {?} */
    GoogleLoginService.prototype.cookieService;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhbG8tZ29vZ2xlLWh5YnJpZC1sb2dpbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vY2hhbG8tZ29vZ2xlLWh5YnJpZC1sb2dpbi8iLCJzb3VyY2VzIjpbImxpYi9jaGFsby1nb29nbGUtaHlicmlkLWxvZ2luLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxtQkFBbUIsRUFBcUIsTUFBTSxvQ0FBb0MsQ0FBQztBQUM1RixPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMzRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMzQyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFbkQsT0FBTyxRQUFRLE1BQU0sV0FBVyxDQUFDOzs7O0FBS2pDLE1BQU07Ozs7Ozs7SUFRSixZQUFpRCxNQUF5QixFQUFVLFdBQXVCLEVBQVUsYUFBZ0MsRUFDM0k7UUFEdUMsV0FBTSxHQUFOLE1BQU0sQ0FBbUI7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBWTtRQUFVLGtCQUFhLEdBQWIsYUFBYSxDQUFtQjtRQUMzSSxrQkFBYSxHQUFiLGFBQWE7dUJBTEwsSUFBSSxPQUFPLEVBQU87b0NBRWIsSUFBSSxPQUFPLEVBQXVCO1FBSXZELElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLCtDQUErQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDaEcsSUFBSSxDQUFDO2dCQUNILElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtvQkFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxJ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LENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDOztZQUNuQixJQUFJLGVBQWUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ3pELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBQyxlQUFlLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUMsS0FBSyxFQUFDLEtBQUssQ0FBQyxDQUFDOztTQUV2RztRQUVELElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBQyxZQUFZLEVBQUMsS0FBSyxFQUFDLEtBQUssQ0FBQyxDQUFBOztLQUUxSDs7O1lBM1BGLFVBQVU7Ozs7NENBU0ksTUFBTSxTQUFDLG1CQUFtQjtZQWxCaEMsVUFBVTtZQUNWLGlCQUFpQjtZQUVqQixhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBHT09HTEVfTE9HSU5fQ09ORklHLCBHb29nbGVMb2dpbkNvbmZpZyB9IGZyb20gJy4vbW9kZWxzL2NoYWxvLWdvb2dsZS1sb2dpbi5jb25maWcnO1xuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMsIEh0dHBQYXJhbXMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBTY3JpcHRMb2FkU2VydmljZSB9IGZyb20gJy4vc2NyaXB0LWxvYWQuc2VydmljZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBDb29raWVTZXJ2aWNlIH0gZnJvbSAnbmd4LWNvb2tpZS1zZXJ2aWNlJztcbmltcG9ydCB7IEdvb2dsZUxvZ2luUmVzcG9uc2UgfSBmcm9tICcuL21vZGVscyc7XG5pbXBvcnQgQ3J5cHRvSlMgZnJvbSAnY3J5cHRvLWpzJztcblxuZGVjbGFyZSB2YXIgZ2FwaTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEdvb2dsZUxvZ2luU2VydmljZTxUPiB7XG4gIGF1dGgyO1xuICBhdXRoT2JzZXJ2YWJsZTogT2JzZXJ2YWJsZTxib29sZWFuIHwgVD47XG4gIHVzZXJPYnNlcnZhYmxlOiBPYnNlcnZhYmxlPGJvb2xlYW4gfCBUPjtcbiAgcHJpdmF0ZSBzdWJqZWN0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xuXG4gIGxvZ2luUmVzcG9uc2VzdWJqZWN0ID0gbmV3IFN1YmplY3Q8R29vZ2xlTG9naW5SZXNwb25zZT4oKTtcblxuICBjb25zdHJ1Y3RvcihASW5qZWN0KEdPT0dMRV9MT0dJTl9DT05GSUcpIHByaXZhdGUgY29uZmlnOiBHb29nbGVMb2dpbkNvbmZpZywgcHJpdmF0ZSBodHRwSGFuZGxlcjogSHR0cENsaWVudCwgcHJpdmF0ZSBzY3JpcHRTZXJ2aWNlOiBTY3JpcHRMb2FkU2VydmljZSxcbiAgICBwcml2YXRlIGNvb2tpZVNlcnZpY2U6IENvb2tpZVNlcnZpY2UpIHtcbiAgICB0aGlzLnNjcmlwdFNlcnZpY2UubG9hZFNjcmlwdCgnaHR0cHM6Ly9hcGlzLmdvb2dsZS5jb20vanMvY2xpZW50OnBsYXRmb3JtLmpzJykuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBnYXBpLmxvYWQoJ2NsaWVudCcsICgpID0+IHtcbiAgICAgICAgICB0aGlzLmF1dGgyID0gZ2FwaS5hdXRoMi5pbml0KHtcbiAgICAgICAgICAgIGNsaWVudF9pZDogdGhpcy5jb25maWcuYXV0aC5nb29nbGUuY2xpZW50X2lkLFxuICAgICAgICAgICAgc2NvcGU6ICdwcm9maWxlJ1xuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmxvZygnZXJyb3IgaW4gaW5pdGlhbGl6aW5nIGF1dGgnKTtcbiAgICAgIH1cbiAgICB9LCBlcnIgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ2Vycm8nLCBlcnIpO1xuICAgIH0pO1xuXG4gIH1cblxuICBnZXRHb29nbGVMb2dpbigpIHtcbiAgICByZXR1cm4gdGhpcy5hdXRoT2JzZXJ2YWJsZSA9IG5ldyBPYnNlcnZhYmxlPGJvb2xlYW4gfCBUPigob2JzZXJ2ZXIpID0+IHtcbiAgICAgIGlmICghdGhpcy5hdXRoMikge1xuICAgICAgICBvYnNlcnZlci5lcnJvcignQXV0aCBpbnN0YW5jZSBpcyBub3QgZGVmaW5lZCcpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5hdXRoMi5ncmFudE9mZmxpbmVBY2Nlc3MoKS50aGVuKChyZXMpID0+IHtcbiAgICAgICAgICB0aGlzLnNlbmRBdXRob3JpemF0aW9uKHJlcy5jb2RlKS5zdWJzY3JpYmUoKGRhdGEpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2V0VXNlclRva2VuKGRhdGEpLnN1YnNjcmliZSgoZDogVCkgPT4ge1xuICAgICAgICAgICAgIHRoaXMuc2V0Q29va2llRGF0YShkYXRhKVxuICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGQpO1xuICAgICAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgICBvYnNlcnZlci5lcnJvcihlcnIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICB9KTtcblxuICB9XG5cbiAgZ2V0VXNlckRldGFpbHMoKSB7XG4gICAgbGV0IHVzZXIgPSB0aGlzLmdldFVzZXJDb29raWVWYWx1ZSgpO1xuICAgIHZhciB1cmwgPSB0aGlzLmNvbmZpZy51c2VyLmF1dGhlbnRpY2F0ZVVzZXJVcmw7XG4gICAgdXJsPWAke3VybH0/dXNlcklkPSR7ZW5jb2RlVVJJQ29tcG9uZW50KHVzZXIpfWBcbiAgICByZXR1cm4gdGhpcy5odHRwSGFuZGxlci5nZXQodXJsKTtcbiAgfVxuXG4gIGdldFRva2VuKCkge1xuICAgIHJldHVybiB0aGlzLnVzZXJPYnNlcnZhYmxlID0gbmV3IE9ic2VydmFibGU8Ym9vbGVhbiB8IFQ+KChvYnNlcnZlcikgPT4ge1xuICAgICAgdGhpcy5nZXRVc2VyRGV0YWlscygpLnN1YnNjcmliZSgodXNlckRldGFpbHMpID0+IHtcbiAgICAgICAgdGhpcy5nZXRVc2VyVG9rZW4odXNlckRldGFpbHMpLnN1YnNjcmliZSgoZDogVCkgPT4ge1xuICAgICAgICAgIG9ic2VydmVyLm5leHQoZCk7XG4gICAgICAgICAgb2JzZXJ2ZXIuY29tcGxldGUoKTtcbiAgICAgICAgfSwgKGVycikgPT4ge1xuICAgICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICAgIH0pXG4gICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgIG9ic2VydmVyLmVycm9yKGVycik7XG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBzZXRHb29nbGVMb2dpblJlc3BvbnNlKGdvb2dsZVJlc3BvbnNlKSB7XG4gICAgdGhpcy5sb2dpblJlc3BvbnNlc3ViamVjdC5uZXh0KGdvb2dsZVJlc3BvbnNlKTtcblxuICB9XG5cbiAgZ2V0R29vZ2xlTG9naW5SZXNwb25zZSgpOiBPYnNlcnZhYmxlPEdvb2dsZUxvZ2luUmVzcG9uc2U+IHtcbiAgICByZXR1cm4gdGhpcy5sb2dpblJlc3BvbnNlc3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG5cbiAgaXNVc2VyQXV0aGVudGljYXRlZCgpIHtcbiAgICBsZXQgdXNlckNvb2tpZSA9IHRoaXMuZ2V0VXNlckNvb2tpZVZhbHVlKCk7XG4gICAgaWYgKHVzZXJDb29raWUpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgZ2V0VXNlckNvb2tpZVZhbHVlKCkge1xuICAgIHJldHVybiB0aGlzLmNvb2tpZVNlcnZpY2UuZ2V0KHRoaXMuY29uZmlnLnVzZXIudXNlckNvb2tpZSk7XG4gIH1cblxuICBzZW5kQXV0aG9yaXphdGlvbih0b2tlbikge1xuICAgIGNvbnN0IHVybCA9IHRoaXMuY29uZmlnLmF1dGhDb2RlVXJsO1xuICAgIGNvbnN0IGhlYWRlclRva2VuID0ge1xuICAgICAga2V5OiAnYXV0aC1jb2RlJyxcbiAgICAgIHZhbHVlOiB0b2tlblxuICAgIH07XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7ICdhdXRoLWNvZGUnOiBoZWFkZXJUb2tlbi52YWx1ZSB9KTtcbiAgICBjb25zdCBvcHRpb25zID0geyBoZWFkZXJzIH07XG4gICAgcmV0dXJuIHRoaXMuaHR0cEhhbmRsZXIucG9zdCh1cmwsIG51bGwsIG9wdGlvbnMpO1xuICB9XG5cbiAgZ2V0VXNlclRva2VuKHVzZXJDcmVkZW50aWFsKSB7XG4gICAgY29uc3QgZGF0YSA9IHtcbiAgICAgIHVzZXJuYW1lOiB1c2VyQ3JlZGVudGlhbC51c2VybmFtZSxcbiAgICAgIHBhc3N3b3JkOiB1c2VyQ3JlZGVudGlhbC5wYXNzd29yZCxcbiAgICAgIGdyYW50X3R5cGU6ICdwYXNzd29yZCdcbiAgICB9O1xuICAgIHJldHVybiB0aGlzLmdldFRva2VuRnJvbVNlcnZlcihkYXRhKTtcbiAgfVxuXG4gIGdldFVzZXJUb2tlbkZyb21SZWZyZXNoVG9rZW4ocmVmcmVzaFRva2VuKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCBkYXRhID0ge1xuICAgICAgcmVmcmVzaF90b2tlbjogcmVmcmVzaFRva2VuLFxuICAgICAgZ3JhbnRfdHlwZTogJ3JlZnJlc2hfdG9rZW4nXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5nZXRUb2tlbkZyb21TZXJ2ZXIoZGF0YSk7XG4gIH1cblxuICBwcml2YXRlIGdldFRva2VuRnJvbVNlcnZlcihkYXRhKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLmNvbmZpZy51c2VyVG9rZW5TZXJ2ZXJVcmw7XG4gICAgY29uc3QgdXJsRW5jb2RlZERhdGEgPSB0aGlzLmdldEVuY29kZWREYXRhKGRhdGEpO1xuICAgIGNvbnN0IGhlYWRlclRva2VuID0ge1xuICAgICAga2V5OiAnQXV0aG9yaXphdGlvbicsXG4gICAgICB2YWx1ZTogJ0Jhc2ljICcgKyBidG9hKGAke3RoaXMuY29uZmlnLmF1dGguc2VydmVyLmNsaWVudF9pZH06JHt0aGlzLmNvbmZpZy5hdXRoLnNlcnZlci5jbGllbnRfc2VjcmV0fWApXG4gICAgfTtcbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHsgQXV0aG9yaXphdGlvbjogaGVhZGVyVG9rZW4udmFsdWUgfSkuc2V0KCdDb250ZW50LVR5cGUnLCAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJyk7XG5cbiAgICBjb25zdCBvcHRpb25zID0geyBoZWFkZXJzIH07XG5cbiAgICByZXR1cm4gdGhpcy5odHRwSGFuZGxlci5wb3N0KHVybCwgdXJsRW5jb2RlZERhdGEsIG9wdGlvbnMpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRFbmNvZGVkRGF0YShkYXRhKSB7XG4gICAgY29uc3QgdXJsRW5jb2RlZERhdGFQYWlycyA9IFtdO1xuICAgIGZvciAoY29uc3QgbmFtZSBpbiBkYXRhKSB7XG4gICAgICBpZiAoZGF0YS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICB1cmxFbmNvZGVkRGF0YVBhaXJzLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KG5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFbbmFtZV0pKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdXJsRW5jb2RlZERhdGEgPSB1cmxFbmNvZGVkRGF0YVBhaXJzLmpvaW4oJyYnKS5yZXBsYWNlKC8lMjAvZywgJysnKTtcbiAgICByZXR1cm4gdXJsRW5jb2RlZERhdGE7XG4gIH1cblxuICBsb2dvdXRVc2VyKCkge1xuICAgIGxldCB1c2VyQ29va2llID0gdGhpcy5nZXRVc2VyQ29va2llVmFsdWUoKVxuICAgIGxldCB1cmwgPSBgJHt0aGlzLmNvbmZpZy5sb2dvdXQubG9nb3V0VXJsfWA7XG4gICAgaWYgKHVzZXJDb29raWUpIHtcbiAgICAgIHRoaXMuY29va2llU2VydmljZS5kZWxldGUodGhpcy5jb25maWcudXNlci51c2VyQ29va2llLCAnLycsICcuY2hhbG8uY29tJyk7XG4gICAgICB1cmwgPSBgJHt1cmx9P3VzZXJJZD0ke3VzZXJDb29raWV9YFxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5odHRwSGFuZGxlci5wb3N0KHVybCwge30sIHsgcmVzcG9uc2VUeXBlOiAndGV4dCcgfSlcbiAgfVxuXG4gIHVwZGF0ZVVzZXJTdGF0ZSgpIHtcbiAgICBsZXQgdXNlckNvb2tpZSA9IHRoaXMuZ2V0VXNlckNvb2tpZVZhbHVlKClcbiAgICAvLyB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KHRoaXMuY29uZmlnLnVzZXIubG9naW5TdGF0ZUNvb2tpZSwgdGhpcy5lbmNyeXB0Q29va2llKCdsb2dnZWRPdXQnKSwgNywgJy8nLCBudWxsLCBmYWxzZSwgJ0xheCcpXG5cbiAgICB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KHRoaXMuY29uZmlnLnVzZXIubG9naW5TdGF0ZUNvb2tpZSwgdGhpcy5lbmNyeXB0Q29va2llKCdsb2dnZWRPdXQnKSwgNywgJy8nLCAnLmNoYWxvLmNvbScsIGZhbHNlLCAnTGF4JylcbiAgICBpZiAodXNlckNvb2tpZSkge1xuICAgICAgLy8gdGhpcy5jb29raWVTZXJ2aWNlLmRlbGV0ZSh0aGlzLmNvbmZpZy51c2VyLnVzZXJDb29raWUsICcvJyk7XG4gICAgICB0aGlzLmNvb2tpZVNlcnZpY2UuZGVsZXRlKHRoaXMuY29uZmlnLnVzZXIudXNlckNvb2tpZSwgJy8nLCAnLmNoYWxvLmNvbScpO1xuICAgIH1cbiAgfVxuXG4gIHNlbmRMb2dvdXRNZXNzYWdlKG1zZzogc3RyaW5nKSB7XG4gICAgdGhpcy5zdWJqZWN0Lm5leHQoeyBtZXNzYWdlOiBtc2cgfSk7XG4gIH1cblxuICBnZXRMb2dvdXRNZXNzYWdlKCk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgcmV0dXJuIHRoaXMuc3ViamVjdC5hc09ic2VydmFibGUoKTtcbiAgfVxuXG4gIGVuY3J5cHRDb29raWUoc3RyaW5nVG9FbmNyeXB0KSB7XG4gICAgdmFyIGtleSA9IENyeXB0b0pTLmVuYy5VdGY4LnBhcnNlKCd3ZWJfY2hhbG9fYXBwa2V5Jyk7XG4gICAgdmFyIGVuY3J5cHRlZFN0cmluZyA9IENyeXB0b0pTLkFFUy5lbmNyeXB0KHN0cmluZ1RvRW5jcnlwdCwga2V5LCB7XG4gICAgICBtb2RlOiBDcnlwdG9KUy5tb2RlLkVDQixcbiAgICAgIHBhZGRpbmc6IENyeXB0b0pTLnBhZC5aZXJvUGFkZGluZ1xuICAgIH0pO1xuICAgIHJldHVybiBlbmNyeXB0ZWRTdHJpbmcudG9TdHJpbmcoKVxuICB9XG5cbiAgZGVjcnlwdFN0cmluZyhlbmNyeXB0ZWRTdHJpbmcpIHtcbiAgICB2YXIga2V5ID0gQ3J5cHRvSlMuZW5jLlV0ZjgucGFyc2UoJ3dlYl9jaGFsb19hcHBrZXknKTtcbiAgICB2YXIgZGVjcnlwdGVkID0gQ3J5cHRvSlMuQUVTLmRlY3J5cHQoZW5jcnlwdGVkU3RyaW5nLCBrZXksIHtcbiAgICAgIG1vZGU6IENyeXB0b0pTLm1vZGUuRUNCLFxuICAgICAgcGFkZGluZzogQ3J5cHRvSlMucGFkLlplcm9QYWRkaW5nXG4gICAgfSk7XG4gICAgcmV0dXJuIGRlY3J5cHRlZC50b1N0cmluZyhDcnlwdG9KUy5lbmMuVXRmOCk7XG4gIH1cblxuICBnZXRVc2VyQ29va2llKCl7XG4gICAgbGV0IGVuY3J5cHRlZENvb2tpZT10aGlzLmdldFVzZXJDb29raWVWYWx1ZSgpO1xuICAgIGxldCBkZWNyeXB0ZWRVc2VyQ29va2llO1xuICAgIGlmKGVuY3J5cHRlZENvb2tpZSkgZGVjcnlwdGVkVXNlckNvb2tpZT0gdGhpcy5kZWNyeXB0U3RyaW5nKGVuY3J5cHRlZENvb2tpZSk7XG4gICAgcmV0dXJuIGRlY3J5cHRlZFVzZXJDb29raWU7XG4gIH1cblxuICBzZW5kT3RwKG51bWJlcil7XG4gICAgbGV0IHVybD1gJHt0aGlzLmNvbmZpZy5zZW5kT3RwVXJsfWBcbiAgIHJldHVybiB0aGlzLmh0dHBIYW5kbGVyLnBvc3QodXJsLHtcIm51bWJlclwiOm51bWJlcn0pXG4gIH1cblxuICB2YWxpZGF0ZVVzZXIoYm9keSl7XG4gICAgbGV0IHVybD1gJHt0aGlzLmNvbmZpZy52YWxpZGF0ZVVzZXJVcmx9YFxuICAgIHJldHVybiB0aGlzLmh0dHBIYW5kbGVyLnBvc3QodXJsLCBib2R5KVxuICB9XG5cbiAgdmFsaWRhdGVPdHAob3RwLG51bWJlcil7XG4gICAgbGV0IHVybD1gJHt0aGlzLmNvbmZpZy52YWxpZGF0ZU90cFVybH1gXG4gICAgbGV0IHBhcmFtcyA9IHRoaXMuZ2V0VVJMU2VhcmNoUGFyYW1zKClcbiAgICAuc2V0KFwib3RwXCIsIG90cClcbiAgICAuc2V0KFwibW9iaWxlXCIsIG51bWJlcik7XG4gICAgcmV0dXJuIHRoaXMuaHR0cEhhbmRsZXIuZ2V0KHVybCwge3BhcmFtc30pO1xuICB9XG5cbiAgZ2V0TW9iaWxlVG9rZW4ob3RwLG51bWJlcil7XG4gICAgcmV0dXJuIHRoaXMudXNlck9ic2VydmFibGUgPSBuZXcgT2JzZXJ2YWJsZTxib29sZWFuIHwgVD4oKG9ic2VydmVyKSA9PiB7XG4gICAgICB0aGlzLnZhbGlkYXRlT3RwKG90cCxudW1iZXIpLnN1YnNjcmliZSgodXNlckRldGFpbHMpID0+IHtcbiAgICAgICAgdGhpcy5nZXRVc2VyVG9rZW4odXNlckRldGFpbHMpLnN1YnNjcmliZSgoZDogVCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2V0Q29va2llRGF0YSh1c2VyRGV0YWlscyk7XG4gICAgICAgICAgb2JzZXJ2ZXIubmV4dChkKTtcbiAgICAgICAgICBvYnNlcnZlci5jb21wbGV0ZSgpO1xuICAgICAgICB9LCAoZXJyKSA9PiB7XG4gICAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgfSlcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgb2JzZXJ2ZXIuZXJyb3IoZXJyKTtcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGdldFVSTFNlYXJjaFBhcmFtcygpOiBIdHRwUGFyYW1zIHtcbiAgICByZXR1cm4gbmV3IEh0dHBQYXJhbXMoKTtcbiAgfVxuXG4gIHNldENvb2tpZURhdGEoZGF0YSl7XG4gICAgaWYgKGRhdGFbJ3VzZXJJZCddKSB7XG4gICAgICB2YXIgZW5jcnlwdGVkU3RyaW5nID0gdGhpcy5lbmNyeXB0Q29va2llKGRhdGFbJ3VzZXJJZCddKTtcbiAgICAgIHRoaXMuY29va2llU2VydmljZS5zZXQodGhpcy5jb25maWcudXNlci51c2VyQ29va2llLGVuY3J5cHRlZFN0cmluZywgNywgJy8nLCAnLmNoYWxvLmNvbScsZmFsc2UsJ0xheCcpO1xuICAgICAgLy8gdGhpcy5jb29raWVTZXJ2aWNlLnNldCh0aGlzLmNvbmZpZy51c2VyLnVzZXJDb29raWUsIGVuY3J5cHRlZFN0cmluZywgNywgJy8nLCBudWxsLCBmYWxzZSwgJ0xheCcpO1xuICAgIH1cblxuICAgIHRoaXMuY29va2llU2VydmljZS5zZXQodGhpcy5jb25maWcudXNlci5sb2dpblN0YXRlQ29va2llLHRoaXMuZW5jcnlwdENvb2tpZSgnbG9nZ2VkSW4nKSwgNywgJy8nLCcuY2hhbG8uY29tJyxmYWxzZSwnTGF4JylcbiAgICAvLyB0aGlzLmNvb2tpZVNlcnZpY2Uuc2V0KHRoaXMuY29uZmlnLnVzZXIubG9naW5TdGF0ZUNvb2tpZSwgdGhpcy5lbmNyeXB0Q29va2llKCdsb2dnZWRJbicpLCA3LCAnLycsIG51bGwsIGZhbHNlLCAnTGF4JylcbiAgfVxuXG59XG5cbiJdfQ==